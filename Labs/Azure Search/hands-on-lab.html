<h1 id="using-azure-search-api">Using Azure Search Api</h1>
<h2 id="overview">Overview</h2>
<p>Azure Search is a fully managed search-as-a-service in the cloud. Azure Search offers scalable full-text search for your apps.</p>
<p>We will examine how quick and easy it is to execute searches with Azure Search, and what extra capabilities it offers us.</p>
<p>This hands-on lab will step you through the following features:</p>
<ol>
<li><strong>Text Search</strong> Using Azure Search to search through a collection of documents.</li>
<li><strong>Spell Corrected Search</strong> Using Azure Search to automatically correct spelling mistakes.</li>
<li><strong>Phonetic Search</strong> Using Azure Search to use &quot;sounds like&quot; searching.</li>
<li><strong>Filtering</strong> Using Azure Search faceting features which make filtering simple.</li>
<li><strong>Geospatial</strong> Using the built-in geospatial filtering makes it simple to do distance or perimeter searches.</li>
</ol>
<h3 id="scenario-overview">Scenario Overview</h3>
<p>We have built an Azure Search index that contains jobs in New York City for the user to find. </p>
<h3 id="about-the-code">About the code</h3>
<p>This lab uses a simple Universal Windows Application as a test application. This simple application can be modified
in order to test the various features of Azure Search.</p>
<p>To begin, open the <code>Azure Search Lab.sln</code> solution in visual studio 2015 and press <code>F5</code> to compile and launch the 
Windows Universal application.</p>
<p>The lab is broken into three <strong>Scenarios</strong>.</p>
<blockquote>
<p><strong>Note:</strong> The Azure Search index that we will be querying during this lab was created via the Azure Portal.
For more information on the Azure Portal refer to the <strong>Appendix</strong> at the bottom of the page.</p>
</blockquote>
<h2 id="scenario-1">Scenario 1</h2>
<p>In this scenario we will introduce <strong>Text Searching</strong> and explain how to use <strong>Spell Corrected Search</strong> and 
<strong>Phonetic Search</strong>.</p>
<h3 id="part-one">Part One</h3>
<p>To begin, run the application. You are presented with a blank application with a texbox at the top. Enter &quot;engineer&quot; 
into this text box and press <code>enter</code>. </p>
<p>You will notice that you did not get any results - let&#39;s fix this.</p>
<p>Navigate to the <code>JobSearchService.cs</code> file.</p>
<p><img src="images/azure_search_service.png" alt=""></p>
<p>Locate the following method:</p>
<pre><code class="lang-csharp">public async Task&lt;DocumentSearchResult&lt;JobResult&gt;&gt; ExecuteSearch(string query, List&lt;FacetGroup&gt; facets = null, PositionDistanceSearch geoSearch = null)
{
        //TO DO - Place holder for search
        return new DocumentSearchResult&lt;JobResult&gt;();
}
</code></pre>
<p>This is just placeholder code. Modify it so that it looks like this:</p>
<pre><code class="lang-csharp">public async Task&lt;DocumentSearchResult&lt;JobResult&gt;&gt; ExecuteSearch(string query, List&lt;FacetGroup&gt; facets = null, PositionDistanceSearch geoSearch = null)
{   
        var searchParameters = new SearchParameters()
        {
            QueryType = QueryType.Full,
            SearchMode = SearchMode.All,
        };
        using (var indexClient = GetClient())
        {
            return await indexClient.Documents.SearchAsync&lt;JobResult&gt;(query, searchParameters);
        }
}
</code></pre>
<p>Press <code>F5</code> to run the application, and type &quot;engineer&quot; into the search box. Press <code>enter</code>; you should be presented with a list of results.</p>
<p>E.g.</p>
<p><img src="images/first_engineer_search.png" alt="Search Results for engineer"></p>
<p>Clear the textbox and type &quot;enginer&quot; (<strong>note</strong> the spelling mistake). Press <code>enter</code> to search. </p>
<p>Notice that the results are identical - Azure Search has automatically detected the spelling mistake and has included this corrected search term along with the original misspelled word.</p>
<p>E.g.</p>
<p><img src="images/second_enginer_search.png" alt="Search Results for enginer"></p>
<p>Clear the textbox and type &quot;kownsil&quot;. Press <code>enter</code> to search. You will see results related to &quot;counsel&quot;.</p>
<p>Azure Search supports phonetic (&quot;sounds like&quot;) searching. With very little work, we have leveraged a very powerful search tool that we can use in our application.</p>
<p>You can learn more about how Azure Search enables phoenetic and spelling mistake handling in the <a href="https://azure.microsoft.com/en-us/blog/custom-analyzers-in-azure-search/">Azure Blog</a></p>
<p>E.g.</p>
<p><img src="images/kownsil_search.png" alt="Search Results for kownsil"></p>
<h3 id="part-two">Part Two</h3>
<p>A common app feature is the &quot;auto-complete&quot; textbox. Azure Search supports auto-complete suggestions out of the box - let&#39;s see how it&#39;s done.</p>
<p>Stop running the application. Return to Visual Studio and navigate to <code>JobSearchService.cs</code>.</p>
<p>Locate the following method stub:</p>
<pre><code class="lang-csharp">public async Task&lt;List&lt;string&gt;&gt; ExecuteSuggest(string query)
{
        //TO DO - Place holder for suggest
        return new List&lt;string&gt;();
}
</code></pre>
<p>Modify the method to look like this:</p>
<pre><code class="lang-csharp">public async Task&lt;List&lt;string&gt;&gt; ExecuteSuggest(string query)
{
    using (var indexClient = GetClient())
    {
        // Query the Azure Search index for search suggestions
        SuggestParameters sp = new SuggestParameters()
        {
            UseFuzzyMatching = true,
            Top = 8
        };
        var results = await indexClient.Documents.SuggestAsync&lt;JobResult&gt;(query, &quot;sg&quot;, sp);

        // Extract the text suggestions from the result set
        return results.Results.Select(e =&gt; e.Text).Distinct().ToList();
    }
}
</code></pre>
<p>You will notice that we are passing <code>sg</code> as the second parameter to the <code>SuggestAsync</code> method. This parameter names a &quot;suggestor&quot; that has been pre-created on the Azure Search 
index that defines which fields should be used to return a set of &quot;suggestions&quot; based on a query.</p>
<p>If you would like to learn more about how Azure Search enables search suggestions, please visit the <a href="https://azure.microsoft.com/en-us/blog/azure-search-how-to-add-suggestions-auto-complete-to-your-search-applications/">Azure Blog</a></p>
<p>Press <code>F5</code> to run the application. Type &quot;eng&quot; into the search box. As you type you should now see the auto complete list appear and suggest search terms to you.</p>
<p>E.g.</p>
<p><img src="images/auto_suggest.png" alt="Auto Suggest Results for Eng"></p>
<h2 id="scenario-2">Scenario 2</h2>
<p>In this scenario we will introduce <strong>Filtering / Faceting</strong>.</p>
<h3 id="part-one">Part One</h3>
<p>Now that we have basic search functionality, wouldn&#39;t it be nice to be able to filter the results further? Luckily this is also very easy with Azure Search using the
&quot;facets&quot; filtering feature.</p>
<p>Navigate to <code>JobSearchService.cs</code> and locate the <code>ExecuteSearch</code> method that we modified in Scenario 1. It should look like this:</p>
<pre><code class="lang-csharp">public async Task&lt;DocumentSearchResult&lt;JobResult&gt;&gt; ExecuteSearch(string query, List&lt;FacetGroup&gt; facets = null, PositionDistanceSearch geoSearch = null)
{   
        var searchParameters = new SearchParameters()
        {
            QueryType = QueryType.Full,
            SearchMode = SearchMode.All,
        };
        using (var indexClient = GetClient())
        {
            return await indexClient.Documents.SearchAsync&lt;JobResult&gt;(query, searchParameters);
        }
}
</code></pre>
<p>Add some facets to the query...</p>
<pre><code class="lang-csharp">Facets = FacetDefinitions.Select(e =&gt; e.Key).ToList()
</code></pre>
<p>...so the method looks like this:</p>
<pre><code class="lang-csharp">public async Task&lt;DocumentSearchResult&lt;JobResult&gt;&gt; ExecuteSearch(string query, List&lt;FacetGroup&gt; facets = null, PositionDistanceSearch geoSearch = null)
{   
        var searchParameters = new SearchParameters()
        {
            QueryType = QueryType.Full,
            SearchMode = SearchMode.All,
            Facets = FacetDefinitions.Select(e =&gt; e.Key).ToList()
        };
        using (var indexClient = GetClient())
        {
            return await indexClient.Documents.SearchAsync&lt;JobResult&gt;(query, searchParameters);
        }
}
</code></pre>
<p><strong>Note:</strong> <code>FacetDefinitions</code> is a Dictionary already defined with the facet names and user-friendly display strings at the top of the class:</p>
<p>This allows you to retreive the number of results available for the categories Agency, Posting_Type and Civil_Service_Title which you can use to further filter the search results.  To learn more about how Facets work, please visit <a href="https://azure.microsoft.com/en-us/documentation/articles/search-faceted-navigation/">https://azure.microsoft.com/en-us/documentation/articles/search-faceted-navigation/</a></p>
<pre><code class="lang-csharp">        public static Dictionary&lt;string, string&gt; FacetDefinitions = new Dictionary&lt;string, string&gt;()
        {
            {&quot;agency&quot;, &quot;Agency&quot;},
            {&quot;posting_type&quot;, &quot;Internal/External&quot;},
            {&quot;civil_service_title&quot;, &quot;Common Job Title&quot;}
        };
</code></pre>
<p>As you can see we are passing in three facets: <code>agency</code>, <code>posting_type</code> and <code>civil_service_title</code>. Let&#39;s run the application and see what this looks like. </p>
<p>Press <code>F5</code> to start the application. Type &quot;engineer&quot; into the search box and press <code>enter</code>.</p>
<p>E.g.</p>
<p><img src="images/engineer_with_facets.png" alt="Auto Suggest Results for Eng"></p>
<p>Azure Search now returns a collection of <em>facets</em> which the user can use to refine their query. We&#39;re rendering them on the UI as a list of checkboxes. </p>
<h3 id="part-two">Part Two</h3>
<p>Now that we have a collection of usable facets, we need to create a filter to ask Azure Search to refine our query.</p>
<p>Return to Visual Studio and open <code>JobSearchService.cs</code>. Go to the <code>ExecuteSearch</code> function and add this line:</p>
<pre><code class="lang-csharp">Filter = CreateFilter(facets, geoSearch)
</code></pre>
<p>...so that the method looks like this:</p>
<pre><code class="lang-csharp">public async Task&lt;DocumentSearchResult&lt;JobResult&gt;&gt; ExecuteSearch(string query, List&lt;FacetGroup&gt; facets = null, PositionDistanceSearch geoSearch = null)
{   
        var searchParameters = new SearchParameters()
        {
            QueryType = QueryType.Full,
            SearchMode = SearchMode.All,          
            Facets = FacetDefinitions.Select(e =&gt; e.Key).ToList(),
            Filter = CreateFilter(facets, geoSearch)
        };
        using (var indexClient = GetClient())
        {
            return await indexClient.Documents.SearchAsync&lt;JobResult&gt;(query, searchParameters);
        }
}
</code></pre>
<p><code>CreateFilter</code> is a method that builds up a filter string for Azure Search. It loops through the given list of facets and encodes each one into the filter string.
This filter is written in OData expression syntax. </p>
<p>Some examples of filters created by this method:</p>
<pre><code>(agency eq &#39;DEPT OF HEALTH/MENTAL HYGIENE&#39;) and (posting_type eq &#39;Internal&#39;)
</code></pre><pre><code>(agency eq &#39;DEPT OF HEALTH/MENTAL HYGIENE&#39; or agency eq &#39;DEPT OF ENVIRONMENT PROTECTION&#39; or agency eq &#39;DEPT OF DESIGN &amp; CONSTRUCTION&#39; or agency eq &#39;HOUSING PRESERVATION &amp; DVLPMNT&#39; or agency eq &#39;DEPT OF INFO TECH &amp; TELECOMM&#39;)
</code></pre><pre><code>(agency eq &#39;DEPT OF ENVIRONMENT PROTECTION&#39;) and (posting_type eq &#39;Internal&#39;) and (civil_service_title eq &#39;ASSOCIATE PROJECT MANAGER&#39;)
</code></pre><p>Press <code>F5</code> to run the application, then execute a search and try out filtering the results by selecting <em>facets</em>.</p>
<h2 id="scenario-3">Scenario 3</h2>
<p>In this scenario we will introduce <strong>Geospatial</strong> filtering.</p>
<p>This allows you to filter results based on their proximity to a specific location or to find all results that are located within a specified boundary.<br>In this example, we will use the location proximity to filter jobs that are located within a certain distance of a specified location.</p>
<h3 id="part-one">Part One</h3>
<p>Azure Search supports geospatial searching if there is an field in your index of the <code>Edm.GeographyPoint</code> type. Let&#39;s see how easy it is to integrate
geospatial search into your queries.</p>
<p>Press <code>F5</code> to run the application and execute an empty search.</p>
<p>Next click on <strong>Map Results</strong> and you should see all the search results plotted on the map.</p>
<p>E.g</p>
<p><img src="images/map_results.png" alt="Map Results"></p>
<h3 id="part-two">Part Two</h3>
<p>Lets add the geo spatial search to the filter.</p>
<p>Return to Visual Studio and open <code>JobSearchService.cs</code>. Locate the <code>CreateFilter</code> method.</p>
<p>Add this section of code before the final <code>return</code>. This code appends the geospatial filter if it has been provided.</p>
<pre><code class="lang-csharp">if (geoSearch != null)
{
    if (query.Length &gt; 0)
    {
        query.Append(&quot; and &quot;);
    }
    var lat = geoSearch.GeoPoint.Position.Latitude;
    var lon = geoSearch.GeoPoint.Position.Longitude;
    query.Append($&quot;geo.distance(geo_location, geography&#39;POINT({lon} {lat})&#39;) le {geoSearch.Radius}&quot;);
}
</code></pre>
<p>Like the <em>facets</em> filter, geospatial filtering is written in OData expression syntax. This is an example of a filter string that allows you to retrieve jobs located within 10KM of a point in New York city :</p>
<pre><code>geo.distance(geo_location, geography&#39;POINT(-73.9593882020563 40.7079201657325)&#39;) le 10
</code></pre><p>Press <code>F5</code> to run the application. Execute an empty search. </p>
<p>Next click on the <strong>Map Results</strong> tab. and you should see all the search results plotted on the map.</p>
<p>Double click on the map to drop a &quot;pin&quot; and select a search radius from the drop-down menu.</p>
<p>E.g.</p>
<p><img src="images/map_results_raduis.png" alt="Map Radius"></p>
<p>Click on <strong>Filter Results</strong>. You will see that the results have been filtered based on their geographical location!</p>
<p>E.g.</p>
<p><img src="images/map_filter.png" alt="Map Filter"></p>
<h3 id="final-notes">Final Notes</h3>
<p>If you would like to learn more about geospatial filtering then check out <a href="https://azure.microsoft.com/en-us/documentation/articles/search-create-geospatial/">Create a geospatial search app using Azure Search</a>.</p>
<p>You can also watch <a href="https://channel9.msdn.com/Shows/Data-Exposed/Azure-Search-and-Geospatial-Data">Azure Search and Geospatial Data</a> on Channel 9.</p>
<h2 id="further-reading">Further Reading</h2>
<p><a href="https://azure.microsoft.com/en-us/documentation/articles/search-howto-stackexchange-data/">https://azure.microsoft.com/en-us/documentation/articles/search-howto-stackexchange-data/</a></p>
<p><a href="https://azure.microsoft.com/en-us/documentation/videos/azure-search-101-getting-started-with-azure-search-with-liam-cavanagh/">Azure Search 101 - Getting started with Azure Search with Liam Cavanagh</a></p>
<p><a href="https://azure.microsoft.com/en-us/documentation/articles/search-what-is-azure-search/">What is Azure Search</a></p>
<p><a href="https://azure.microsoft.com/en-us/documentation/services/search/">Search Documentation</a></p>
<h2 id="appendix">Appendix</h2>
<p>The Azure Portal was used to create the Azure Search server. The Azure Portal can be found at <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</p>
<p>Some features that you can use in Azure Portal with Azure Search include:</p>
<h4 id="overview">Overview</h4>
<p>Allows you to view database settings and document/collection counts for your server.</p>
<p><img src="images/jobs_lab_azure_search1.png" alt=""></p>
<h4 id="index-viewer">Index Viewer</h4>
<p>Allows you to view your indexes and the fields they include. You can also modify them from here.</p>
<p><img src="images/jobs_lab_azure_search2.png" alt=""></p>
<h4 id="search-explorer">Search Explorer</h4>
<p>Test out your search and filter strings, and view the results.</p>
<p><img src="images/jobs_lab_azure_search3.png" alt=""></p>
